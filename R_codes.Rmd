---
title: "Obesity project"
author: "Rodrigo Delibnerato"
date: "3/28/2018"
output: word_document
---

## Data visualization, transformation and assessing normality

```{r transformation}

total_rod$ethnicity<-as.factor(total_rod$ethnicity)
total_rod$hospitaladmitsource<-as.factor(total_rod$hospitaladmitsource)
total_rod$hospitaladmityear<-as.factor(total_rod$hospitaladmityear)
total_rod$unittype<-as.factor(total_rod$unittype)
total_rod$unitadmitsource<-as.factor(total_rod$unitadmitsource)
total_rod$apacheadmissiondx<-as.factor(total_rod$apacheadmissiondx)
total_rod$hospitalid<-as.factor(total_rod$hospitalid)

hist(total_rod$age_fixed)
hist(total_rod$height)
hist(total_rod$weight)
hist(total_rod$bmi)
hist(total_rod$charlson_score)
hist(total_rod$sofatotal)
hist(total_rod$apachescore)


with(total_rod , qqnorm((age_fixed)))
with(total_rod , qqnorm((height)))
with(total_rod , qqnorm((weight)))
with(total_rod , qqnorm((bmi)))
with(total_rod , qqnorm((charlson_score)))
with(total_rod , qqnorm((sofatotal)))
with(total_rod , qqnorm((apachescore)))

summary(total_rod)

```

## Subsetting the data in:
   underweight
   normal
   overweight
   obese
```{r subseting}

under<-subset(total_rod, bmi_group == "underweight")

normal<-subset(total_rod,bmi_group == "normal weight")

over<-subset(total_rod, bmi_group =="overweight")

obese<-subset(total_rod, bmi_group =="obese")

```

##Table 1 - manuscript

https://github.com/kaz-yos/tableone

https://www.r-bloggers.com/table-1-and-the-characteristics-of-study-population/

https://www.rdocumentation.org/packages/tableone/versions/0.8.1/topics/print.TableOne

http://rstudio-pubs-static.s3.amazonaws.com/13321_da314633db924dc78986a850813a50d5.html
```{r Table 1}

library(tableone)
require(ReporteRs)
require(magrittr)


listVars<- c("age_fixed","gender","ethnicity","bmi","apache_n_comorbidity","charlson_score",  "unitadmitsource", "unittype","region","numbedscategory","teachingstatus", "electivesurgery","sofatotal", "apachescore","oasis","intubated_first_24h")

catVars<-c("gender","ethnicity", "unitadmitsource","apache_n_comorbidity", "unittype","region","numbedscategory","teachingstatus","electivesurgery","intubated_first_24h")

table1 <- CreateTableOne(vars = listVars, data = total_rod, factorVars = catVars,testNormal=oneway.test, strata = c("bmi_category"))


table1<-print(table1,nonnormal=c("sofatotal"),testApprox=c("gender","ethnicity", "unitadmitsource", "unittype","region","numbedscategory","teachingstatus","electivesurgery","intubated_first_24h"))

docx( ) %>% 
     addFlexTable(table1 %>%
     FlexTable(header.cell.props = cellProperties( background.color = "#003366"),
               header.text.props = textBold( color = "white" ),
               add.rownames = TRUE ) %>%
               setZebraStyle( odd = "#DDDDDD", even = "#FFFFFF" ) ) %>%
     writeDoc(file = "table1.docx")

browseURL("table1.docx") #wordfile
````
##  Assessing discrimination of original APACHE-IV and OASIS for the total dataset and also for each BMI category 

```{r ROC curve and AUC 95% ci}

library(ROCR)
library(ggplot2)

## Making ROC curve and AUC for final dataset for APACHE-IV

pred<-prediction(total_rod$predictedhospitalmortality, total_rod$diedinhospital)
perf<-performance(pred, "tpr", "fpr")

roc.perf = performance(pred, measure = "tpr", x.measure = "fpr")
plot(roc.perf)
abline(a=0, b= 1)

library (pROC)

roc_total<-roc(total_rod$diedinhospital, total_rod$predictedhospitalmortality)
auc(roc_total)
ci.auc(roc_total)

## Making ROC curve and AUC for underweight  for APACHE-IV

pred_under<- prediction(under$predictedhospitalmortality, under$diedinhospital)
perf_under<- performance(pred_under, "tpr", "fpr")

roc.perf_under = performance (pred_under, measure = "tpr", x.measure = "fpr")
plot (roc.perf_under)
abline(a=0, b= 1)

roc_under<-roc(under$diedinhospital, under$predictedhospitalmortality)
auc(roc_under)
ci.auc(roc_under)

## Making ROC curve and AUC for normal weight for APACHE-IV

pred_normal<- prediction(normal$predictedhospitalmortality, normal$diedinhospital)
perf_normal<- performance(pred_normal, "tpr", "fpr")

roc.perf_normal = performance (pred_normal, measure = "tpr", x.measure = "fpr")
plot (roc.perf_normal)
abline(a=0, b= 1)

roc_normal<-roc(normal$diedinhospital, normal$predictedhospitalmortality)
auc(roc_normal)
ci.auc(roc_normal)

## Making ROC curve and AUC for  overweight for APACHE-IV

pred_over<- prediction(over$predictedhospitalmortality, over$diedinhospital)
perf_over<- performance(pred_over, "tpr", "fpr")

roc.perf_over = performance (pred_over, measure = "tpr", x.measure = "fpr")
plot (roc.perf_over)
abline(a=0, b= 1)

roc_over<-roc(over$diedinhospital, over$predictedhospitalmortality)
auc(roc_over)
ci.auc(roc_over)

## Making ROC curve and AUC for obese for APACHE-IV

pred_obese<- prediction(obese$predictedhospitalmortality, obese$diedinhospital)
perf_obese<- performance(pred_obese, "tpr", "fpr")

roc.perf_obese = performance (pred_obese, measure = "tpr", x.measure = "fpr")
plot (roc.perf_obese)
abline(a=0, b= 1)

roc_obese<-roc(obese$diedinhospital, obese$predictedhospitalmortality)
auc(roc_obese)
ci.auc(roc_obese)


### Making AUC and ci.AUC for oasis per BMI category

roc_total1<-roc(total_rod$diedinhospital, total_rod$oasis_prob)
auc(roc_total1)
ci.auc(roc_total1)

roc_under1<-roc(under$diedinhospital, under$oasis_prob)
auc(roc_under1)
ci.auc(roc_under1)

roc_normal1<-roc(normal$diedinhospital, normal$oasis_prob)
auc(roc_normal1)
ci.auc(roc_normal1)

roc_over1<-roc(over$diedinhospital, over$oasis_prob)
auc(roc_over1)
ci.auc(roc_over1)

roc_obese1<-roc(obese$diedinhospital, obese$oasis_prob)
auc(roc_obese1)
ci.auc(roc_obese1)

```

## Assessing calibration (HL) of original APACHE-IV and OASIS for total datasetand and also for each BMI category 


```{r calibration - hosmer lemeshow}

library(ResourceSelection)

hl<-hoslem.test(total_rod$diedinhospital,total_rod$predictedhospitalmortality, g=10)
hl


hl_under<-hoslem.test(under$diedinhospital,under$predictedhospitalmortality, g=10)
hl_under

hl_normal<-hoslem.test(normal$diedinhospital,normal$predictedhospitalmortality, g=10)
hl_normal

hl_over<-hoslem.test(over$diedinhospital,over$predictedhospitalmortality, g=10)
hl_over

hl_obese<-hoslem.test(obese$diedinhospital,obese$predictedhospitalmortality, g=10)
hl_obese

```
## Assessing calibration (SMR) of original APACHE-IV and OASIS for total datasetand and also for each BMI category 

```{r SMR 95% CI}

## APACHE-IV
a<- sum(total_rod$diedinhospital)
b<- sum(total_rod$predictedhospitalmortality)
a/b

c<-sum(under$diedinhospital)
d<-sum(under$predictedhospitalmortality)
c/d

e<- sum(normal$diedinhospital)
f<-sum (normal$predictedhospitalmortality)
e/f

g<- sum(over$diedinhospital)
h<- sum (over$predictedhospitalmortality)
g/h

i<- sum(obese$diedinhospital)
j<- sum(obese$predictedhospitalmortality)
i/j

## SMR for OASIS
aaa<- sum(total_rod$diedinhospital)
bbb<- sum(total_rod$oasis_prob)
aaa/bbb

ccc<-sum(under$diedinhospital)
ddd<-sum(under$oasis_prob)
ccc/ddd

eee<- sum(normal$diedinhospital)
fff<-sum (normal$oasis_prob)
eee/fff

ggg<- sum(over$diedinhospital)
hhh<- sum (over$oasis_prob)
ggg/hhh

iii<- sum(obese$diedinhospital)
jjj<- sum(obese$oasis_prob)
iii/jjj

```

## Creating the two new models using Logistic Regression: 

   APACHE IV and OASIS recalibrated vs APACHE IV and OASIS recalibrated + BMI

How?
1. Splitting training and test
2. classifiers creation - 4 new classifiers

```{r splitting training and test set }

# relevel BMi category
total_rod$bmi_category<-as.factor(total_rod$bmi_category)
levels(total_rod$bmi_category)
total_rod$bmi_category<-factor(total_rod$bmi_category,levels(total_rod$bmi_category)[c(4,1,3,2)])

# Splitting the dataset in two new ones  with our variables(prediciton + BMI category +diedinhospital) to make our models

apache_models<-total_rod [,c(66,71,68)] #original apache prediction, bmi category,diedinhospital

oasis_models <-total_rod [,c(65,71,68)] #original oasis prediction, bmi category, diedinhospital


## Splitting the two new datasets into the training and test set

library(caTools)

set.seed(123)
split = sample.split(apache_models$diedinhospital,SplitRatio = 0.7)

apache_training_set =subset(apache_models, split == TRUE)

apache_test_set = subset (apache_models, split == FALSE)


set.seed(123)
split = sample.split(oasis_models$diedinhospital,SplitRatio = 0.7)

oasis_training_set =subset(oasis_models, split == TRUE)

oasis_test_set = subset (oasis_models, split == FALSE)

## Now, let`s create 4 new classifiers in the training set:

  -- 1.  fit=apache_predicted_recalib            (recalibration + BMI)
  -- 2.  fit.null=apache_predicted_recalib_null  (just recalibration)
  -- 3.  fit2=oasis_predicted_recalib            (recalibration + BMI)
  -- 4.  fit.null2=oasis_predicted_recalib_null  (just recalibration)

## 1. classifier for the model recalibration APACHE + BMI
logit <- function(x) {
	return(log(x/(1-x)))
}

fit <- glm(diedinhospital ~ offset(logit(predictedhospitalmortality)) 
           + bmi_category,data=apache_training_set,family="binomial")

 

## 2. classifier for the model recalibration APACHE 

logit <- function(x) {
	return(log(x/(1-x)))
}

fit.null <- glm(diedinhospital ~ offset(logit(predictedhospitalmortality)) 
                ,data=apache_training_set,family="binomial")


## 3.classifier for the  model recalibration OASIS +BMI 
logit <- function(x) {
	return(log(x/(1-x)))
}

fit2 <- glm(diedinhospital ~ offset(logit(oasis_prob)) + bmi_category,   
            data=oasis_training_set,family="binomial")



## 4.  classifier for the model recalibration OASIS 

logit <- function(x) {
	return(log(x/(1-x)))
}

fit.null2 <- glm(diedinhospital ~ offset(logit(oasis_prob)),
                 data=oasis_training_set,family="binomial")

 

````

## Adding the prediction (made in the training set) into the Test Set

```{r adding predction into the test set}
 apache_test_set$apache_predicted_recalib<-NA
 apache_test_set$apache_predicted_recalib <- predict(fit, type='response', 
                                                     newdata=apache_test_set) 
 apache_test_set$apache_predicted_recalib_null <- NA
 apache_test_set$apache_predicted_recalib_null <- predict(fit.null, type= 'response',
                                                          newdata = apache_test_set)

 oasis_test_set$oasis_predicted_recalib <- NA
 oasis_test_set$oasis_predicted_recalib <- predict(fit2, type='response',
                                                   newdata = oasis_test_set)

 oasis_test_set$oasis_predicted_recalib_null <- NA
 oasis_test_set$oasis_predicted_recalib_null <- predict(fit.null2, type= 'response',
                                                        newdata = oasis_test_set)

```

## Splitting TEST SET into BMI categories

```{r splitting}

apache_under_test<-subset(apache_test_set, bmi_category == "underweight")
oasis_under_test<-subset(oasis_test_set, bmi_category == "underweight")

apache_normal_test<-subset(apache_test_set,bmi_category == "normal weight")
oasis_normal_test<-subset(oasis_test_set,bmi_category == "normal weight")

apache_over_test<-subset(apache_test_set, bmi_category =="overweight")
oasis_over_test<-subset(oasis_test_set, bmi_category =="overweight")

apache_obese_test<-subset(apache_test_set, bmi_category =="obese")
oasis_obese_test<-subset(oasis_test_set, bmi_category =="obese")

```

## Assessing the performance of these two new models in the TEST SET, according to the BMI category

1. Discrimination: AUROC (95% CI)
2. Calibration:
    a.SMR (95% CI)
    b.HL
    c.calibration plot
    
 ## For APACHE + BMI model

```{r}

## Calculating AUROC APACHE IV + BMI 

library (pROC)

roc_total2<-roc(apache_test_set$diedinhospital, apache_test_set$apache_predicted_recalib)
auc(roc_total2)
ci.auc(roc_total2)


roc_under2<-roc(apache_under_test$diedinhospital, apache_under_test$apache_predicted_recalib)
auc(roc_under2)
ci.auc(roc_under2)

roc_normal2<-roc(apache_normal_test$diedinhospital, apache_normal_test$apache_predicted_recalib)
auc(roc_normal2)
ci.auc(roc_normal2)

roc_over2<-roc(apache_over_test$diedinhospital, apache_over_test$apache_predicted_recalib)
auc(roc_over2)
ci.auc(roc_over2)

roc_obese2<-roc(apache_obese_test$diedinhospital, apache_obese_test$apache_predicted_recalib)
auc(roc_obese2)
ci.auc(roc_obese2)

#SMR for APACHE + BMI

a<- sum(apache_test_set$diedinhospital)
b<- sum(apache_test_set$apache_predicted_recalib)
a/b

c<-sum(apache_under_test$diedinhospital)
d<-sum(apache_under_test$apache_predicted_recalib)
c/d

e<- sum(apache_normal_test$diedinhospital)
f<-sum (apache_normal_test$apache_predicted_recalib)
e/f

g<- sum(apache_over_test$diedinhospital)
h<- sum (apache_over_test$apache_predicted_recalib)
g/h

i<- sum(apache_obese_test$diedinhospital)
j<- sum(apache_obese_test$apache_predicted_recalib)
i/j

#HL for APACHE + BMI

library(ResourceSelection)

hl2<-hoslem.test(apache_test_set$diedinhospital,
                 apache_test_set$apache_predicted_recalib, g=10)
hl2

hl_under2<-hoslem.test(apache_under_test$diedinhospital,
                       apache_under_test$apache_predicted_recalib, g=10)
hl_under2

hl_normal2<-hoslem.test(apache_normal_test$diedinhospital,
                        apache_normal_test$apache_predicted_recalib, g=10)
hl_normal2

hl_over2<-hoslem.test(apache_over_test$diedinhospital,
                      apache_over_test$apache_predicted_recalib, g=10)
hl_over2

hl_obese2<-hoslem.test(apache_obese_test$diedinhospital,
                       apache_obese_test$apache_predicted_recalib, g=10)
hl_obese2


# calibration plot APACHE IV + BMI, per BMI category


apache_test_set$bmi_category<-as.factor(apache_test_set$bmi_category)
levels(apache_test_set$bmi_category)
apache_test_set$bmi_category<-factor(apache_test_set$bmi_category,
                                     levels(apache_test_set$bmi_category)[c(4,1,3,2)])

library(dplyr)


apache_test_set %>% 
     group_by(bmi_category,dec_group=Hmisc::cut2(apache_predicted_recalib,seq(0,1,0.1))) %>%  
     summarise(n=n(),mortRate=mean(diedinhospital,na.rm=T)
     ,mean_risk=mean(apache_predicted_recalib)) %>% 
     ggplot(aes(mean_risk,mortRate,col=bmi_category)) + 
     geom_line() + 
     geom_abline(aes(intercept=0,slope=1),linetype=3)  +
     xlab("Predicted Mortality") + 
     ylab("Observed Mortality") + 
     ggtitle("  APACHE-IV (recalibrated + BMI) calibration plot, per BMI category") +
     scale_x_continuous(limits=c(0,1)) +
     scale_y_continuous(limits=c(0,1)) +
     theme(plot.title = element_text(hjust = 0.5))

```

## For APACHE IV recalibrated (without BMI)

```{r}

#AUROC for APACHE IV (without BMI)

library (pROC)

roc_total3<-roc(apache_test_set$diedinhospital,
                apache_test_set$apache_predicted_recalib_null)
auc(roc_total3)
ci.auc(roc_total3)

roc_under3<-roc(apache_under_test$diedinhospital,
                apache_under_test$apache_predicted_recalib_null)
auc(roc_under3)
ci.auc(roc_under3)

roc_normal3<-roc(apache_normal_test$diedinhospital, 
                 apache_normal_test$apache_predicted_recalib_null)
auc(roc_normal3)
ci.auc(roc_normal3)

roc_over3<-roc(apache_over_test$diedinhospital,
               apache_over_test$apache_predicted_recalib_null)
auc(roc_over3)
ci.auc(roc_over3)

roc_obese3<-roc(apache_obese_test$diedinhospital,
                apache_obese_test$apache_predicted_recalib_null)
auc(roc_obese3)
ci.auc(roc_obese3)

#SMR for APACHE IV (without BMI)

a<- sum(apache_test_set$diedinhospital)
b<- sum(apache_test_set$apache_predicted_recalib_null)
a/b

c<-sum(apache_under_test$diedinhospital)
d<-sum(apache_under_test$apache_predicted_recalib_null)
c/d

e<- sum(apache_normal_test$diedinhospital)
f<-sum (apache_normal_test$apache_predicted_recalib_null)
e/f

g<- sum(apache_over_test$diedinhospital)
h<- sum (apache_over_test$apache_predicted_recalib_null)
g/h

i<- sum(apache_obese_test$diedinhospital)
j<- sum(apache_obese_test$apache_predicted_recalib_null)
i/j

#HL for APACHE IV (without BMI)

library(ResourceSelection)

hl3<-hoslem.test(apache_test_set$diedinhospital,
                 apache_test_set$apache_predicted_recalib_null, g=10)
hl3

hl_under3<-hoslem.test(apache_under_test$diedinhospital,
                       apache_under_test$apache_predicted_recalib_null, g=10)
hl_under3

hl_normal3<-hoslem.test(apache_normal_test$diedinhospital,
                        apache_normal_test$apache_predicted_recalib_null, g=10)
hl_normal3

hl_over3<-hoslem.test(apache_over_test$diedinhospital,
                      apache_over_test$apache_predicted_recalib_null, g=10)
hl_over3

hl_obese3<-hoslem.test(apache_obese_test$diedinhospital,
                       apache_obese_test$apache_predicted_recalib_null, g=10)
hl_obese3


#calibration plot for APACHE IV (without BMI)

apache_test_set$bmi_category<-as.factor(apache_test_set$bmi_category)
levels(apache_test_set$bmi_category)
apache_test_set$bmi_category<-factor(apache_test_set$bmi_category,
                                     levels(apache_test_set$bmi_category)[c(4,1,3,2)])

library(dplyr)

apache_test_set %>% 
     group_by(bmi_category,dec_group=Hmisc::cut2(apache_predicted_recalib_null,seq(0,1,0.1))) %>%  
     summarise(n=n(),mortRate=mean(diedinhospital,na.rm=T)
     ,mean_risk=mean(apache_predicted_recalib_null)) %>% 
     ggplot(aes(mean_risk,mortRate,col=bmi_category)) + 
  
     geom_line() + 
     geom_abline(aes(intercept=0,slope=1),linetype=3)  +
     xlab("Predicted Mortality") + 
     ylab("Observed Mortality") + 
     ggtitle(" APACHE-IV (recalibrated) calibration plot, per BMI category") +
     scale_x_continuous(limits=c(0,1)) +
     scale_y_continuous(limits=c(0,1)) +
     theme(plot.title = element_text(hjust = 0.5))

````

## For OASIS + BMI model
```{r}

#AUROC for OASIS + BMI model

library (pROC)

roc_total4<-roc(oasis_test_set$diedinhospital,
                oasis_test_set$oasis_predicted_recalib)
auc(roc_total4)
ci.auc(roc_total4)

roc_under4<-roc(oasis_under_test$diedinhospital, 
                oasis_under_test$oasis_predicted_recalib)
auc(roc_under4)
ci.auc(roc_under4)

roc_normal4<-roc(oasis_normal_test$diedinhospital, 
                 oasis_normal_test$oasis_predicted_recalib)
auc(roc_normal4)
ci.auc(roc_normal4)

roc_over4<-roc(oasis_over_test$diedinhospital, 
               oasis_over_test$oasis_predicted_recalib)
auc(roc_over4)
ci.auc(roc_over4)

roc_obese4<-roc(oasis_obese_test$diedinhospital, 
                oasis_obese_test$oasis_predicted_recalib)
auc(roc_obese4)
ci.auc(roc_obese4)

#SMR for OASIS + BMI model

a<- sum(oasis_test_set$diedinhospital)
b<- sum(oasis_test_set$oasis_predicted_recalib)
a/b

c<-sum(oasis_under_test$diedinhospital)
d<-sum(oasis_under_test$oasis_predicted_recalib)
c/d

e<- sum(oasis_normal_test$diedinhospital)
f<-sum (oasis_normal_test$oasis_predicted_recalib)
e/f

g<- sum(oasis_over_test$diedinhospital)
h<- sum(oasis_over_test$oasis_predicted_recalib)
g/h

i<- sum(oasis_obese_test$diedinhospital)
j<- sum(oasis_obese_test$oasis_predicted_recalib)
i/j

#HL for OASIS + BMI model

library(ResourceSelection)

hl4<-hoslem.test(oasis_test_set$diedinhospital,
                 oasis_test_set$oasis_predicted_recalib, g=10)
hl4

hl_under4<-hoslem.test(oasis_under_test$diedinhospital,
                       oasis_under_test$oasis_predicted_recalib, g=10)
hl_under4

hl_normal4<-hoslem.test(oasis_normal_test$diedinhospital,
                        oasis_normal_test$oasis_predicted_recalib, g=10)
hl_normal4

hl_over4<-hoslem.test(oasis_over_test$diedinhospital,
                      oasis_over_test$oasis_predicted_recalib, g=10)
hl_over4

hl_obese4<-hoslem.test(oasis_obese_test$diedinhospital,
                       oasis_obese_test$oasis_predicted_recalib, g=10)
hl_obese4


#calibration plot for OASIS + BMI model

oasis_test_set$bmi_category<-as.factor(apache_test_set$bmi_category)
levels(oasis_test_set$bmi_category)
oasis_test_set$bmi_category<-factor(oasis_test_set$bmi_category,
                                     levels(oasis_test_set$bmi_category)[c(4,1,3,2)])

library(dplyr)

oasis_test_set %>% 
     group_by(bmi_category,dec_group=Hmisc::cut2(oasis_predicted_recalib,seq(0,1,0.1))) %>%  
     summarise(n=n(),mortRate=mean(diedinhospital,na.rm=T)
               ,mean_risk=mean(oasis_predicted_recalib)) %>% 
     ggplot(aes(mean_risk,mortRate,col=bmi_category)) + 
  
     geom_line() + 
     geom_abline(aes(intercept=0,slope=1),linetype=3)  +
     xlab("Predicted Mortality") + 
     ylab("Observed Mortality") + 
     ggtitle(" OASIS (recalibrated + BMI) calibration plot, per BMI category") +
     scale_x_continuous(limits=c(0,1)) +
     scale_y_continuous(limits=c(0,1)) +
     theme(plot.title = element_text(hjust = 0.5))


```

## OASIS recalibration without BMI

```{r}

#AUROC for OASIS (without BMI)

library (pROC)

roc_total5<-roc(oasis_test_set$diedinhospital, 
                oasis_test_set$oasis_predicted_recalib_null)
auc(roc_total5)
ci.auc(roc_total5)

roc_under5<-roc(oasis_under_test$diedinhospital, 
                oasis_under_test$oasis_predicted_recalib_null)
auc(roc_under5)
ci.auc(roc_under5)

roc_normal5<-roc(oasis_normal_test$diedinhospital, 
                 oasis_normal_test$oasis_predicted_recalib_null)
auc(roc_normal5)
ci.auc(roc_normal5)

roc_over5<-roc(oasis_over_test$diedinhospital, 
               oasis_over_test$oasis_predicted_recalib_null)
auc(roc_over5)
ci.auc(roc_over5)

roc_obese5<-roc(oasis_obese_test$diedinhospital, 
                oasis_obese_test$oasis_predicted_recalib_null)
auc(roc_obese5)
ci.auc(roc_obese5)

#SMR for OASIS (without BMI)

a<- sum(oasis_test_set$diedinhospital)
b<- sum(oasis_test_set$oasis_predicted_recalib_null)
a/b

c<-sum(oasis_under_test$diedinhospital)
d<-sum(oasis_under_test$oasis_predicted_recalib_null)
c/d

e<- sum(oasis_normal_test$diedinhospital)
f<-sum (oasis_normal_test$oasis_predicted_recalib_null)
e/f

g<- sum(oasis_over_test$diedinhospital)
h<- sum(oasis_over_test$oasis_predicted_recalib_null)
g/h

i<- sum(oasis_obese_test$diedinhospital)
j<- sum(oasis_obese_test$oasis_predicted_recalib_null)
i/j

#HL for OASIS (without BMI)

library(ResourceSelection)

hl5<-hoslem.test(oasis_test_set$diedinhospital,
                 oasis_test_set$oasis_predicted_recalib_null, g=10)
hl5

hl_under5<-hoslem.test(oasis_under_test$diedinhospital,
                       oasis_under_test$oasis_predicted_recalib_null, g=10)
hl_under5

hl_normal5<-hoslem.test(oasis_normal_test$diedinhospital,
                        oasis_normal_test$oasis_predicted_recalib_null, g=10)
hl_normal5

hl_over5<-hoslem.test(oasis_over_test$diedinhospital,
                      oasis_over_test$oasis_predicted_recalib_null, g=10)
hl_over5

hl_obese5<-hoslem.test(oasis_obese_test$diedinhospital,
                       oasis_obese_test$oasis_predicted_recalib_null, g=10)
hl_obese5



#calibration plot for OASIS (without BMI)

oasis_test_set$bmi_category<-as.factor(apache_test_set$bmi_category)
levels(oasis_test_set$bmi_category)
oasis_test_set$bmi_category<-factor(oasis_test_set$bmi_category,
                                     levels(oasis_test_set$bmi_category)[c(4,1,3,2)])

library(dplyr)

oasis_test_set %>% 
     group_by(bmi_category,dec_group=Hmisc::cut2(oasis_predicted_recalib_null,seq(0,1,0.1))) %>%  
     summarise(n=n(),mortRate=mean(diedinhospital,na.rm=T)
               ,mean_risk=mean(oasis_predicted_recalib_null)) %>% 
     ggplot(aes(mean_risk,mortRate,col=bmi_category)) + 
  
     geom_line() + 
     geom_abline(aes(intercept=0,slope=1),linetype=3)  +
     xlab("Predicted Mortality") + 
     ylab("Observed Mortality") + 
     ggtitle(" OASIS (recalibrated) calibration plot, per BMI category") +
     scale_x_continuous(limits=c(0,1)) +
     scale_y_continuous(limits=c(0,1)) +
     theme(plot.title = element_text(hjust = 0.5))



```

## Making the Calibration belt
https://cran.r-project.org/web/packages/givitiR/vignettes/givitiR.html

```{r calibration belt}
library(givitiR)

#calibration plot for APACHE IV
data("total_rod")
cb <- givitiCalibrationBelt(o = total_rod$diedinhospital, 
                            e = total_rod$predictedhospitalmortality,
                            devel = "external") #the model has been developed on an external sample(external).
plot(cb, main = "APACHE IV calibration",
                          xlab = "APACHE IV predicted probability",
                          ylab = "Observed mortality")

#calibration plot for OASIS
data ("total_rod")
cb <- givitiCalibrationBelt(o = total_rod$diedinhospital, 
                            e = total_rod$oasis_prob,
                            devel = "external") #the model has been developed on an external sample(external).
plot(cb, main = "OASIS calibration",
                          xlab = "OASIS predicted probability",
                          ylab = "Observed mortality")

#calibration plot for APACHE IV recalibrated

data ("apache_test_set")
cb <- givitiCalibrationBelt(o = apache_test_set$diedinhospital, 
                            e = apache_test_set$apache_predicted_recalib_null,
                            devel = "internal") #the model has been fit on the same dataset underevaluation(internal)
plot(cb, main = "APACHE IV recalibrated ",
                          xlab = "APACHE IV recalibrated predicted probability",
                          ylab = "Observed mortality")


#calibration plot for APACHE IV recalibrated by BMI group

data ("apache_test_set")
cb <- givitiCalibrationBelt(o = apache_test_set$diedinhospital, 
                            e = apache_test_set$apache_predicted_recalib,
                            devel = "internal") #the model has been fit on the same dataset underevaluation(internal)
plot(cb, main = "APACHE IV recalibrated by BMI group ",
                          xlab = "APACHE IV recalibrated by BMI group predicted probability",
                          ylab = "Observed mortality")


#calibration plot for OASIS recalibrated

data ("oasis_test_set")
cb <- givitiCalibrationBelt(o = oasis_test_set$diedinhospital, 
                            e = oasis_test_set$oasis_predicted_recalib_null,
                            devel = "internal") #the model has been fit on the same dataset underevaluation(internal)
plot(cb, main = "OASIS recalibrated ",
                          xlab = "OASIS recalibrated predicted probability",
                          ylab = "Observed mortality")


#calibration plot for OASIS recalibrated by BMI group

data ("oasis_test_set")
cb <- givitiCalibrationBelt(o = oasis_test_set$diedinhospital, 
                            e = oasis_test_set$oasis_predicted_recalib,
                            devel = "internal") #the model has been fit on the same dataset underevaluation(internal)
plot(cb, main = "OASIS recalibrated by BMI group ",
                          xlab = "OASIS recalibrated by BMI group predicted probability",
                          ylab = "Observed mortality")

